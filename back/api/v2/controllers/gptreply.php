<?php
use GuzzleHttp\Client;


function createCompletion($request)
{
  // urlã‚’æŒ‡å®š
  $apiUrl = 'https://api.openai.com/v1/chat/completions';
  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼
  $headers = array(
    'Content-Type: application/json',
    'Authorization: Bearer ' . getenv("OPENAI_API_KEY")
  );
  
  // cURLã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
  $ch = curl_init($apiUrl);
  
  // cURLã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
  curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'POST');
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
  curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($request));
  curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
  
  // cURLãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œ
  $gptresponse = curl_exec($ch);

  // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
  if ($gptresponse === false) {
    error_log(print_r(curl_error($ch), true) . "\n", 3, dirname(__FILE__).'/debugA.log');
    throw new ErrorException("curlã«ã‚ˆã‚‹å¤±æ•—");
  }

  // APIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ã™ã‚‹
  $result = json_decode($gptresponse, true);

  // ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹
  $generatedText = $result['choices'][0]['message']['content'];

  return $generatedText;
}


function makeReplyIntroduction($event)
{
  // error_log(print_r($event, true) . "\n", 3, dirname(__FILE__).'/debugA.log');
  // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ ¼ç´
  $generatedText = "ã™ã„ã¾ã›ã‚“ï¼Œã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸğŸ¤”";
  // è‡ªå‹•å›ç­”åˆ¤å®šãƒ•ãƒ©ã‚°
  $autoreply_flag = false;

  // GPTã«ã‚ˆã‚‹è³ªå•ã®ã‚¸ãƒ£ãƒ³ãƒ«åˆ†ã‘
  $data = [
    'model' => 'gpt-4',
    'messages' => [
      ['role' => 'system', 'content' =>
      "ã‚ãªãŸã¯é€ã‚‰ã‚Œã¦ããŸè³ªå•ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«åˆ†é¡ã™ã‚‹äººã§ã™.\
      é€ã‚‰ã‚Œã‚‹è³ªå•ã«å¯¾ã—ï¼Œã‚«ãƒ†ã‚´ãƒªåã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ï¼\
      \
      åˆ¶ç´„æ¡ä»¶ï¼š\
      ï¼Šè¿”ä¿¡ã™ã‚‹å†…å®¹ã¯ã‚«ãƒ†ã‚´ãƒªåã®ã¿ã§è¡Œã£ã¦ãã ã•ã„\
      ï¼Šchatbotã®è‡ªèº«ã‚’ç¤ºã™ä¸€äººç§°ã¯ï¼Œç§ã§ã™\
      \
      ã‚«ãƒ†ã‚´ãƒªåï¼š\
      ï¼Šchatbotã‚·ã‚¹ãƒ†ãƒ ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šæˆæ¥­ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šèª²é¡Œã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šã‚¨ãƒ©ãƒ¼ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã«é–¢ã™ã‚‹è³ªå•\
      \
      å›ç­”ã®ä¾‹ï¼š\
      ï¼Šchatbotã‚·ã‚¹ãƒ†ãƒ ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šæˆæ¥­ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šèª²é¡Œã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šã‚¨ãƒ©ãƒ¼ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã«é–¢ã™ã‚‹è³ªå•\
      ",
      ],
      ['role' => 'assistant', 'content' => $event->getText()],
      ['role' => 'user', 'content' => 'ã“ã®è³ªå•å†…å®¹ã«ç›¸å½“ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’è¿”ã—ã¦ãã ã•ã„'],
    ],
    'max_tokens' => 500,
  ];

  try {
    $generatedText = createCompletion($data);
  }catch (Exception $e){
    error_log(print_r($e, true) . "\n", 3, dirname(__FILE__).'/debug.log');
  }

  if (preg_match("/ãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã«é–¢ã™ã‚‹è³ªå•/", $generatedText) || preg_match("/ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†ã«é–¢ã™ã‚‹è³ªå•/", $generatedText) || preg_match("/ã‚¨ãƒ©ãƒ¼ã«é–¢ã™ã‚‹è³ªå•/", $generatedText))
  {
    $autoreply_flag = True;
  }
  if ($autoreply_flag) {
    // $data = [
    //   'model' => 'gpt-4',
    //   'messages' => [
    //     ['role' => 'system', 'content' =>
    //     "ã‚ãªãŸã¯æ•™å¸«ã§ã‚ã‚Šï¼Œå­¦ç”Ÿã®è³ªå•ã«å›ç­”ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼\
    //     ã¾ãŸï¼Œæœ¬æˆæ¥­ã¯ï¼ŒRè¨€èªã‚’ç”¨ã„ãŸæƒ…å ±ç³»ã®è¬›ç¾©ã§ã‚ã‚Šï¼Œ\
    //     ä¸»ã«ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ã«é–¢ã™ã‚‹åˆ†é‡ã‚’æ‰±ã£ã¦ã„ã¾ã™ï¼\
    //     ä»¥ä¸Šã‚’è¸ã¾ãˆãŸä¸Šã§ï¼Œé€ã‚‰ã‚ŒãŸè³ªå•ã«å¯¾ã—\
    //     é©åˆ‡ãªå›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼\
    //     \
    //     è³ªå•ã®è§£ç­”ã¯Rè¨€èªã‚’å‰æã¨ã—ã¦ç”Ÿæˆã—ã¦ãã ã•ã„ï¼\
    //     \
    //     è³ªå•ã®ä¸­ã«ã¯å›ç­”ã™ã‚‹ã«ã‚ãŸã£ã¦æƒ…å ±ãŒä¸ååˆ†ãªå ´åˆãŒã‚ã‚Šã¾ã™ï¼\
    //     ãã®éš›ã¯æƒ…å ±ãŒè¶³ã‚Šãªã„æ—¨ã‚’ä¼ãˆï¼Œ\
    //     å›ç­”ã™ã‚‹ãŸã‚ã«å¿…è¦ãªæƒ…å ±ã‚’è¿½è¨˜ã™ã‚‹ã‚ˆã†ã«å‚¬ä¿ƒã—ã¦ãã ã•ã„ï¼",
    //     ],
    //     ['role' => 'assistant', 'content' => $event->getText()],
    //     ['role' => 'user', 'content' => 'ã“ã®è³ªå•å†…å®¹ã¸ã®è§£ç­”ã‚’è¿”ã—ã¦ãã ã•ã„'],
    //   ],
    //   'max_tokens' => 500,
    // ];
    $data = [
      'model' => 'gpt-4',
      'messages' => [
        ['role' => 'system', 'content' =>
        "ã‚ãªãŸã¯æ•™å¸«ã§ã‚ã‚Šï¼Œå­¦ç”Ÿã®è³ªå•ã«å›ç­”ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼\
        ã¾ãŸï¼Œæœ¬æˆæ¥­ã¯ï¼ŒRè¨€èªã‚’ç”¨ã„ãŸæƒ…å ±ç³»ã®è¬›ç¾©ã§ã‚ã‚Šï¼Œ\
        ä¸»ã«ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ã«é–¢ã™ã‚‹åˆ†é‡ã‚’æ‰±ã£ã¦ã„ã¾ã™ï¼\
        ä»¥ä¸Šã‚’è¸ã¾ãˆãŸä¸Šã§ï¼Œé€ã‚‰ã‚ŒãŸè³ªå•ã«å¯¾ã—\
        ãƒ’ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼\
        \
        ãƒ’ãƒ³ãƒˆã®ä¸­ã«ã¯è³ªå•ã«å¯¾ã™ã‚‹è€ƒãˆæ–¹ã‚„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ç¤ºã™å†…å®¹ãŒå«ã¾ã‚Œã‚‹ã¹ãã§ã™ï¼\
        å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã‚„è§£ç­”ã¯é¿ã‘ï¼Œå­¦ç”ŸãŒè‡ªã‚‰è€ƒãˆã‚‹æ‰‹åŠ©ã‘ã¨ãªã‚‹ã‚ˆã†å¿ƒãŒã‘ã¦ãã ã•ã„ï¼\
        \
        è³ªå•ã«å›ç­”ã™ã‚‹ãŸã‚ã«ã¯ï¼Œæ™‚æŠ˜æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼\
        ãã®éš›ã¯ï¼Œæƒ…å ±ãŒè¶³ã‚Šãªã„æ—¨ã‚’ä¼ãˆï¼Œå¿…è¦ãªæƒ…å ±ã‚’è¿½è¨˜ã™ã‚‹ã‚ˆã†ã«å­¦ç”Ÿã«å‚¬ä¿ƒã—ã¦ãã ã•ã„ï¼",
        ],
        ['role' => 'assistant', 'content' => $event->getText()],
        ['role' => 'user', 'content' => 'ã“ã®è³ªå•å†…å®¹ã¸ã®ãƒ’ãƒ³ãƒˆã‚’è¿”ã—ã¦ãã ã•ã„'],
      ],
      'max_tokens' => 500,
    ];
    try {
      $generatedText = createCompletion($data);
    }catch (Exception $e){
      error_log(print_r($e, true) . "\n", 3, dirname(__FILE__).'/debug.log');
    }
  } else {
    $generatedText = "å…ˆç”Ÿã«èã„ã¦ã¿ã‚ˆã†ã‹ğŸ¤”";
  }

  // ãƒ‡ãƒãƒƒã‚°
  // error_log(print_r($result, true) . "\n", 3, dirname(__FILE__).'/debugA.log');
  error_log(print_r($generatedText, true) . "\n", 3, dirname(__FILE__).'/debugA.log');
  return $generatedText;
}

function makeReplyInvitation_typeA($event, $number)
{
  // error_log(print_r($event, true) . "\n", 3, dirname(__FILE__).'/debugA.log');
  // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ ¼ç´
  $generatedText = "ã™ã„ã¾ã›ã‚“ï¼Œã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸğŸ¤”";
  // è‡ªå‹•å›ç­”åˆ¤å®šãƒ•ãƒ©ã‚°
  $autoreply_flag = false;

  // GPTã«ã‚ˆã‚‹è³ªå•ã®ã‚¸ãƒ£ãƒ³ãƒ«åˆ†ã‘
  $data = [
    'model' => 'gpt-4',
    'messages' => [
      ['role' => 'system', 'content' =>
      "ã‚ãªãŸã¯é€ã‚‰ã‚Œã¦ããŸè³ªå•ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«åˆ†é¡ã™ã‚‹äººã§ã™.\
      é€ã‚‰ã‚Œã‚‹è³ªå•ã«å¯¾ã—ï¼Œã‚«ãƒ†ã‚´ãƒªåã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ï¼\
      \
      åˆ¶ç´„æ¡ä»¶ï¼š\
      ï¼Šè¿”ä¿¡ã™ã‚‹å†…å®¹ã¯ã‚«ãƒ†ã‚´ãƒªåã®ã¿ã§è¡Œã£ã¦ãã ã•ã„\
      ï¼Šchatbotã®è‡ªèº«ã‚’ç¤ºã™ä¸€äººç§°ã¯ï¼Œç§ã§ã™\
      \
      ã‚«ãƒ†ã‚´ãƒªåï¼š\
      ï¼Šchatbotã‚·ã‚¹ãƒ†ãƒ ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šæˆæ¥­ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šèª²é¡Œã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šã‚¨ãƒ©ãƒ¼ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã«é–¢ã™ã‚‹è³ªå•\
      \
      å›ç­”ã®ä¾‹ï¼š\
      ï¼Šchatbotã‚·ã‚¹ãƒ†ãƒ ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šæˆæ¥­ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šèª²é¡Œã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šã‚¨ãƒ©ãƒ¼ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã«é–¢ã™ã‚‹è³ªå•\
      ",
      ],
      ['role' => 'assistant', 'content' => $event->getText()],
      ['role' => 'user', 'content' => 'ã“ã®è³ªå•å†…å®¹ã«ç›¸å½“ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’è¿”ã—ã¦ãã ã•ã„'],
    ],
    'max_tokens' => 500,
  ];

  try {
    $generatedText = createCompletion($data);
  }catch (Exception $e){
    error_log(print_r($e, true) . "\n", 3, dirname(__FILE__).'/debug.log');
  }

  if (preg_match("/ãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã«é–¢ã™ã‚‹è³ªå•/", $generatedText) || preg_match("/ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†ã«é–¢ã™ã‚‹è³ªå•/", $generatedText) || preg_match("/ã‚¨ãƒ©ãƒ¼ã«é–¢ã™ã‚‹è³ªå•/", $generatedText))
  {
    $autoreply_flag = True;
  }
  if ($autoreply_flag) {
    $data = [
      'model' => 'gpt-4',
      'messages' => [
        ['role' => 'system', 'content' =>
        "ã‚ãªãŸã¯æ•™å¸«ã§ã‚ã‚Šï¼Œå­¦ç”Ÿã®è³ªå•ã«å›ç­”ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼\
        ã¾ãŸï¼Œæœ¬æˆæ¥­ã¯ï¼ŒExcelãªã©ã‚’ç”¨ã„ãŸæƒ…å ±ç³»ã®è¬›ç¾©ã§ã‚ã‚Šï¼Œ\
        ä¸»ã«ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ã«é–¢ã™ã‚‹åˆ†é‡ã‚’æ‰±ã£ã¦ã„ã¾ã™ï¼\
        ä»¥ä¸Šã‚’è¸ã¾ãˆãŸä¸Šã§ï¼Œé€ã‚‰ã‚ŒãŸè³ªå•ã«å¯¾ã—\
        ãƒ’ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼\
        \
        ãƒ’ãƒ³ãƒˆã®ä¸­ã«ã¯è³ªå•ã«å¯¾ã™ã‚‹è€ƒãˆæ–¹ã‚„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ç¤ºã™å†…å®¹ãŒå«ã¾ã‚Œã‚‹ã¹ãã§ã™ï¼\
        å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã‚„è§£ç­”ã¯é¿ã‘ï¼Œå­¦ç”ŸãŒè‡ªã‚‰è€ƒãˆã‚‹æ‰‹åŠ©ã‘ã¨ãªã‚‹ã‚ˆã†å¿ƒãŒã‘ã¦ãã ã•ã„ï¼\
        \
        è³ªå•ã«å›ç­”ã™ã‚‹ãŸã‚ã«ã¯ï¼Œæ™‚æŠ˜æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼\
        ãã®éš›ã¯ï¼Œæƒ…å ±ãŒè¶³ã‚Šãªã„æ—¨ã‚’ä¼ãˆï¼Œå¿…è¦ãªæƒ…å ±ã‚’è¿½è¨˜ã™ã‚‹ã‚ˆã†ã«å­¦ç”Ÿã«å‚¬ä¿ƒã—ã¦ãã ã•ã„ï¼",
        ],
        ['role' => 'assistant', 'content' => $event->getText()],
        ['role' => 'user', 'content' => 'ã“ã®è³ªå•å†…å®¹ã¸ã®ãƒ’ãƒ³ãƒˆã‚’è¿”ã—ã¦ãã ã•ã„'],
      ],
      'max_tokens' => 500,
    ];
    try {
      $generatedText = createCompletion($data);
    }catch (Exception $e){
      error_log(print_r($e, true) . "\n", 3, dirname(__FILE__).'/debug.log');
    }
  } else {
    $generatedText = "å…ˆç”Ÿã«èã„ã¦ã¿ã‚ˆã†ã‹ğŸ¤”";
  }

  // ãƒ‡ãƒãƒƒã‚°
  // error_log(print_r($result, true) . "\n", 3, dirname(__FILE__).'/debugA.log');
  error_log(print_r($generatedText, true) . "\n", 3, dirname(__FILE__).'/debugA.log');
  return $generatedText;
}

function makeReplyInvitation_typeB($event, $number)
{
  // error_log(print_r($event, true) . "\n", 3, dirname(__FILE__).'/debugA.log');
  // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ ¼ç´
  $generatedText = "ã™ã„ã¾ã›ã‚“ï¼Œã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸğŸ¤”";
  // è‡ªå‹•å›ç­”åˆ¤å®šãƒ•ãƒ©ã‚°
  $autoreply_flag = false;

  // GPTã«ã‚ˆã‚‹è³ªå•ã®ã‚¸ãƒ£ãƒ³ãƒ«åˆ†ã‘
  $data = [
    'model' => 'gpt-4',
    'messages' => [
      ['role' => 'system', 'content' =>
      "ã‚ãªãŸã¯é€ã‚‰ã‚Œã¦ããŸè³ªå•ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«åˆ†é¡ã™ã‚‹äººã§ã™.\
      é€ã‚‰ã‚Œã‚‹è³ªå•ã«å¯¾ã—ï¼Œã‚«ãƒ†ã‚´ãƒªåã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ï¼\
      \
      åˆ¶ç´„æ¡ä»¶ï¼š\
      ï¼Šè¿”ä¿¡ã™ã‚‹å†…å®¹ã¯ã‚«ãƒ†ã‚´ãƒªåã®ã¿ã§è¡Œã£ã¦ãã ã•ã„\
      ï¼Šchatbotã®è‡ªèº«ã‚’ç¤ºã™ä¸€äººç§°ã¯ï¼Œç§ã§ã™\
      \
      ã‚«ãƒ†ã‚´ãƒªåï¼š\
      ï¼Šchatbotã‚·ã‚¹ãƒ†ãƒ ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šæˆæ¥­ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šèª²é¡Œã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šã‚¨ãƒ©ãƒ¼ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã«é–¢ã™ã‚‹è³ªå•\
      \
      å›ç­”ã®ä¾‹ï¼š\
      ï¼Šchatbotã‚·ã‚¹ãƒ†ãƒ ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šæˆæ¥­ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šèª²é¡Œã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šã‚¨ãƒ©ãƒ¼ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†ã«é–¢ã™ã‚‹è³ªå•\
      ï¼Šãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã«é–¢ã™ã‚‹è³ªå•\
      ",
      ],
      ['role' => 'assistant', 'content' => $event->getText()],
      ['role' => 'user', 'content' => 'ã“ã®è³ªå•å†…å®¹ã«ç›¸å½“ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’è¿”ã—ã¦ãã ã•ã„'],
    ],
    'max_tokens' => 500,
  ];

  try {
    $generatedText = createCompletion($data);
  }catch (Exception $e){
    error_log(print_r($e, true) . "\n", 3, dirname(__FILE__).'/debug.log');
  }

  if (preg_match("/ãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã«é–¢ã™ã‚‹è³ªå•/", $generatedText) || preg_match("/ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†ã«é–¢ã™ã‚‹è³ªå•/", $generatedText) || preg_match("/ã‚¨ãƒ©ãƒ¼ã«é–¢ã™ã‚‹è³ªå•/", $generatedText))
  {
    $autoreply_flag = True;
  }
  if ($autoreply_flag) {
    if ($number < 5){
      $data = [
        'model' => 'gpt-4',
        'messages' => [
          ['role' => 'system', 'content' =>
          "ã‚ãªãŸã¯æ•™å¸«ã§ã‚ã‚Šï¼Œå­¦ç”Ÿã®è³ªå•ã«å›ç­”ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼\
          ã¾ãŸï¼Œæœ¬æˆæ¥­ã¯ï¼ŒExcelãªã©ã‚’ç”¨ã„ãŸæƒ…å ±ç³»ã®è¬›ç¾©ã§ã‚ã‚Šï¼Œ\
          ä¸»ã«ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ã«é–¢ã™ã‚‹åˆ†é‡ã‚’æ‰±ã£ã¦ã„ã¾ã™ï¼\
          ä»¥ä¸Šã‚’è¸ã¾ãˆãŸä¸Šã§ï¼Œé€ã‚‰ã‚ŒãŸè³ªå•ã«å¯¾ã—\
          ãƒ’ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼\
          \
          ãƒ’ãƒ³ãƒˆã®ä¸­ã«ã¯è³ªå•ã«å¯¾ã™ã‚‹è€ƒãˆæ–¹ã‚„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ç¤ºã™å†…å®¹ãŒå«ã¾ã‚Œã‚‹ã¹ãã§ã™ï¼\
          å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã‚„è§£ç­”ã¯é¿ã‘ï¼Œå­¦ç”ŸãŒè‡ªã‚‰è€ƒãˆã‚‹æ‰‹åŠ©ã‘ã¨ãªã‚‹ã‚ˆã†å¿ƒãŒã‘ã¦ãã ã•ã„ï¼\
          \
          è³ªå•ã«å›ç­”ã™ã‚‹ãŸã‚ã«ã¯ï¼Œæ™‚æŠ˜æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼\
          ãã®éš›ã¯ï¼Œæƒ…å ±ãŒè¶³ã‚Šãªã„æ—¨ã‚’ä¼ãˆï¼Œå¿…è¦ãªæƒ…å ±ã‚’è¿½è¨˜ã™ã‚‹ã‚ˆã†ã«å­¦ç”Ÿã«å‚¬ä¿ƒã—ã¦ãã ã•ã„ï¼",
          ],
          ['role' => 'assistant', 'content' => $event->getText()],
          ['role' => 'user', 'content' => 'ã“ã®è³ªå•å†…å®¹ã¸ã®ãƒ’ãƒ³ãƒˆã‚’è¿”ã—ã¦ãã ã•ã„'],
        ],
        'max_tokens' => 500,
      ];
      try {
        $generatedText = createCompletion($data);
      }catch (Exception $e){
        error_log(print_r($e, true) . "\n", 3, dirname(__FILE__).'/debug.log');
      }
    }else{
      $data = [
        'model' => 'gpt-4',
        'messages' => [
          ['role' => 'system', 'content' =>
          "ã‚ãªãŸã¯æ•™å¸«ã§ã‚ã‚Šï¼Œå­¦ç”Ÿã®è³ªå•ã«å›ç­”ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼\
          ã¾ãŸï¼Œæœ¬æˆæ¥­ã¯ï¼ŒRè¨€èªã‚„Pythonè¨€èªãªã©ã‚’ç”¨ã„ãŸæƒ…å ±ç³»ã®è¬›ç¾©ã§ã‚ã‚Šï¼Œ\
          ä¸»ã«ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ã«é–¢ã™ã‚‹åˆ†é‡ã‚’æ‰±ã£ã¦ã„ã¾ã™ï¼\
          ä»¥ä¸Šã‚’è¸ã¾ãˆãŸä¸Šã§ï¼Œé€ã‚‰ã‚ŒãŸè³ªå•ã«å¯¾ã—\
          ãƒ’ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼\
          \
          ãƒ’ãƒ³ãƒˆã®ä¸­ã«ã¯è³ªå•ã«å¯¾ã™ã‚‹è€ƒãˆæ–¹ã‚„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ç¤ºã™å†…å®¹ãŒå«ã¾ã‚Œã‚‹ã¹ãã§ã™ï¼\
          å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã‚„è§£ç­”ã¯é¿ã‘ï¼Œå­¦ç”ŸãŒè‡ªã‚‰è€ƒãˆã‚‹æ‰‹åŠ©ã‘ã¨ãªã‚‹ã‚ˆã†å¿ƒãŒã‘ã¦ãã ã•ã„ï¼\
          \
          è³ªå•ã«å›ç­”ã™ã‚‹ãŸã‚ã«ã¯ï¼Œæ™‚æŠ˜æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼\
          ãã®éš›ã¯ï¼Œæƒ…å ±ãŒè¶³ã‚Šãªã„æ—¨ã‚’ä¼ãˆï¼Œå¿…è¦ãªæƒ…å ±ã‚’è¿½è¨˜ã™ã‚‹ã‚ˆã†ã«å­¦ç”Ÿã«å‚¬ä¿ƒã—ã¦ãã ã•ã„ï¼",
          ],
          ['role' => 'assistant', 'content' => $event->getText()],
          ['role' => 'user', 'content' => 'ã“ã®è³ªå•å†…å®¹ã¸ã®ãƒ’ãƒ³ãƒˆã‚’è¿”ã—ã¦ãã ã•ã„'],
        ],
        'max_tokens' => 500,
      ];
      try {
        $generatedText = createCompletion($data);
      }catch (Exception $e){
        error_log(print_r($e, true) . "\n", 3, dirname(__FILE__).'/debug.log');
      }
    }
  } else {
    $generatedText = "å…ˆç”Ÿã«èã„ã¦ã¿ã‚ˆã†ã‹ğŸ¤”";
  }

  // ãƒ‡ãƒãƒƒã‚°
  // error_log(print_r($result, true) . "\n", 3, dirname(__FILE__).'/debugA.log');
  error_log(print_r($generatedText, true) . "\n", 3, dirname(__FILE__).'/debugA.log');
  return $generatedText;
}